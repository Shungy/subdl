#!/bin/sh
# License: MIT (Expat)

usage="usage: ${0##*/} [-e episode] [-i imdbid] [-s season] [-l sublanguageid] [-r results] [-c (no cut)] [-n (non-interactive)] [query]"

tmpfile=$(mktemp /tmp/subdl-XXXXXX)

trap 'rm "$tmpfile"' 0 1 15

urlencode() {
	printf "%s" "$1" | tr '[:upper:]' '[:lower:]' | \
		printf "%%%s" $(od -v -t x1 -An -) # Do NOT quote!
}

checknum() {
	echo "$1" | grep '^[0-9]\+$' > /dev/null || {
		echo season, episode, results must be natural numbers.
		exit 1
	}
}

checklang() {
	echo "$1" | grep '^[a-z]\{3\}\(,[a-z]\{3\}\)*$' > /dev/null || {
		echo language code must be 3 letters.
		echo multiple languages are separated with comma.
		exit 1
	}
}

checkimdbid() {
	echo "$1" | grep '^[0-9]\{7\}$' > /dev/null || {
		echo imdbid must be 7 figures.
		echo imdbid should exclude property prefix.
		exit 1
	}
}


while getopts r:cne:i:s:l: opt
do
	case $opt in
		r) checknum "$OPTARG"
		   rows="$OPTARG"               ;;
		c) cols="0"                     ;;
		n) dontask="1"                  ;;
		e) checknum "$OPTARG"
		   episode="$OPTARG"            ;;
		i) checkimdbid "$OPTARG"
		   imdbid="$OPTARG"             ;;
		s) checknum "$OPTARG"
		   season="$OPTARG"             ;;
		l) checklang "$OPTARG"
		   sublanguageid="$OPTARG"      ;;
		\?) echo "$usage" ; exit 1      ;;
	esac
done
shift $(( OPTIND - 1 ))

[ -z "$1" ] && [ -z "$imdbid" ] && {
	echo "$usage"
	exit 1
}

if [ -f "$1" ]
then
	query=$(urlencode "${1##*/}")
elif [ -n "$1" ]
then
	query=$(urlencode "$*")
fi

[ -z "$rows" ] && {
	rows=$(( $(tput lines) - 2 ))
	[ "$rows" -lt 4 ] && rows=4
}

[ -z "$cols" ] && cols=$(tput cols)

curl -s -S -A 'TemporaryUserAgent' "https://rest.opensubtitles.org/search\
${episode:+/episode-}${episode}\
${imdbid:+/imdbid-}${imdbid}\
${query:+/query-}${query}\
${season:+/season-}${season}\
${sublanguageid:+/sublanguageid-}${sublanguageid}" > "$tmpfile"

[ -z "$dontask" ] && {
	jq -e -j --argjson rows "$rows" --argjson cols "$cols" '
	if $rows != 0
	then
		del(.[$rows:])
	else
		.
	end |
	if length == 0
	then
		"no result.\n" | halt_error(1)
	else
		[[range(length) | tostring] , [.[].SubFileName]] |
		transpose | .[] | " " +  .[0] + ": " + .[1] |
		if $cols != 0
		then
			.[:$cols] | . + "\n"
		else
			. + "\n"
		end
	end' "$tmpfile" || {
		cat "$tmpfile"
		printf "\n"
		exit 1
	}

	printf "Subtitle number: "
	read -r nu
}

if [ -z "$nu" ]
then
	nu=0
else
	checknum "$nu"
fi

dlurl=$(jq -j --argjson nu "$nu" '.[$nu].SubDownloadLink' "$tmpfile")
filename=$(jq -j --argjson nu "$nu" '.[$nu].SubFileName' "$tmpfile")

curl -s -S "$dlurl" | gzip -d > "$filename" && echo Fetched "$filename"
